# Configuración de PostgreSQL para el Proyecto

**PostgreSQL versión instalada**: 16.10 [x]

## Paso 1: Acceder a PostgreSQL como superusuario

Ejecuta los siguientes comandos en tu terminal:

```bash
# Cambiar al usuario postgres del sistema
sudo -i -u postgres

# Acceder a PostgreSQL
psql
```

## Paso 2: Crear usuario/rol para el proyecto

Dentro de la consola de PostgreSQL (`postgres=#`), ejecuta:

```sql
-- Crear usuario con contraseña
CREATE USER arboles_user WITH PASSWORD 'PON_AQUI_TU_CONTRASEÑA';

-- Dar privilegios de creación de bases de datos
ALTER USER arboles_user CREATEDB;

-- Verificar que se creó
\du
```

**Nota**: Cambia `arboles_password_2024` por una contraseña segura que recuerdes.

## Paso 3: Crear la base de datos

Dentro de la consola de PostgreSQL:

```sql
-- Crear la base de datos
CREATE DATABASE proyecto_arboles;

-- Dar permisos al usuario
GRANT ALL PRIVILEGES ON DATABASE proyecto_arboles TO arboles_user;

-- Conectar a la nueva base de datos
\c proyecto_arboles

-- Dar permisos en el schema public
GRANT ALL ON SCHEMA public TO arboles_user;

-- Verificar que se creó
\l
```

## Paso 4: Instalar extensión TimescaleDB

### Opción A: Si TimescaleDB ya está disponible

Dentro de la base de datos `proyecto_arboles`:

```sql
-- Intentar crear la extensión
CREATE EXTENSION IF NOT EXISTS timescaledb;
```

### Opción B: Si TimescaleDB no está instalado

Sal de PostgreSQL (`\q`) y ejecuta en la terminal:

```bash
# Salir del usuario postgres
exit

# Añadir repositorio de TimescaleDB
sudo sh -c "echo 'deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(lsb_release -c -s) main' > /etc/apt/sources.list.d/timescaledb.list"

# Importar clave GPG
wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg

# Actualizar e instalar
sudo apt update
sudo apt install timescaledb-2-postgresql-16

# Configurar TimescaleDB
sudo timescaledb-tune --quiet --yes

# Reiniciar PostgreSQL
sudo systemctl restart postgresql
```

Luego vuelve a conectarte como postgres y ejecuta:

```sql
-- Conectar a la base de datos
\c proyecto_arboles

-- Crear la extensión
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- Verificar
\dx
```

## Paso 5: Verificar configuración

```sql
-- Ver extensiones instaladas
\dx

-- Ver usuarios
\du

-- Ver bases de datos
\l

-- Salir
\q
```

## Paso 6: Probar conexión con el usuario del proyecto

Sal de PostgreSQL y del usuario postgres (`exit`), luego en tu terminal normal:

```bash
# Probar conexión con el nuevo usuario
psql -U arboles_user -d proyecto_arboles -h localhost

# Si pide contraseña, usa la que configuraste en el Paso 2
```

Si funciona, verás el prompt: `proyecto_arboles=>`

## Paso 7: Configurar application.properties del backend

Una vez que PostgreSQL esté configurado, actualiza el archivo:

`backend/src/main/resources/application.properties`

```properties
# Configuración de la base de datos
spring.datasource.url=jdbc:postgresql://localhost:5432/proyecto_arboles
spring.datasource.username=arboles_user
spring.datasource.password=AQUI_TU_CONTRASEÑA

# JPA/Hibernate
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.format_sql=true

# Server
server.port=8080
```

**IMPORTANTE**: No commitear este archivo con la contraseña real. Crear un archivo `application-local.properties` que esté en `.gitignore`.

## Comandos útiles de PostgreSQL

```bash
# Ver estado del servicio
sudo systemctl status postgresql

# Iniciar PostgreSQL
sudo systemctl start postgresql

# Detener PostgreSQL
sudo systemctl stop postgresql

# Reiniciar PostgreSQL
sudo systemctl restart postgresql

# Habilitar inicio automático
sudo systemctl enable postgresql
```

## Comandos útiles dentro de psql

```sql
\l          -- Listar bases de datos
\du         -- Listar usuarios/roles
\dt         -- Listar tablas
\dx         -- Listar extensiones
\c dbname   -- Conectar a base de datos
\q          -- Salir
```

## Solución de problemas comunes

### Error: "Peer authentication failed"

Esto significa que PostgreSQL está configurado para usar autenticación por peer (usuario del sistema).

Solución:

```bash
# Editar configuración
sudo nano /etc/postgresql/16/main/pg_hba.conf

# Buscar la línea:
local   all             postgres                                peer

# Cambiarla por:
local   all             postgres                                md5

# También buscar:
local   all             all                                     peer

# Cambiarla por:
local   all             all                                     md5

# Guardar (Ctrl+O, Enter, Ctrl+X)

# Reiniciar PostgreSQL
sudo systemctl restart postgresql
```

### Error: "role does not exist"

Necesitas crear el usuario como se muestra en el Paso 2.

### Error: "database does not exist"

Necesitas crear la base de datos como se muestra en el Paso 3.

---

**Siguiente paso**: Una vez completada esta configuración, podrás ejecutar el backend con `./mvnw spring-boot:run`
