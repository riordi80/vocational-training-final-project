# Sistema de Roles y Permisos

**Fecha**: 2026-02-13
**Estado**: Frontend y Backend implementados (pendiente: paginas de arboles/centros, gestion de usuarios)
**Objetivo**: Simplificar el sistema de acceso a 3 niveles: Admin, Coordinador y Público

---

## Resumen del Sistema

El sistema tiene 3 tipos de acceso:

| Tipo de acceso | Requiere cuenta | Descripción |
|----------------|-----------------|-------------|
| **ADMIN** | Si | Acceso total al sistema |
| **COORDINADOR** | Si | Gestiona los centros a los que esta asignado |
| **Publico** | No | Acceso de solo lectura a todo el contenido |

> **Principio**: La app es publica para lectura. Solo se necesita cuenta para crear, editar o eliminar contenido.

### Cambios respecto al diseno anterior

| Antes | Despues |
|-------|---------|
| 2 roles globales: ADMIN, USUARIO | 2 roles: ADMIN, COORDINADOR |
| 4 roles por centro: COORDINADOR, PROFESOR, ESTUDIANTE, OBSERVADOR | Sin roles por centro |
| Login obligatorio para ver contenido | Acceso publico sin login (solo lectura) |
| `usuario_centro.rol_en_centro` | Se elimina la columna `rol_en_centro` |

---

## Matriz de Permisos

| Accion | Publico (sin cuenta) | COORDINADOR | ADMIN |
|--------|----------------------|-------------|-------|
| Ver dashboard | Si | Si | Si |
| Ver lista de centros | Si | Si | Si |
| Ver arboles de cualquier centro | Si | Si | Si |
| Ver detalle de arbol | Si | Si | Si |
| Crear arbol | No | Si (en sus centros) | Si |
| Editar arbol | No | Si (en sus centros) | Si |
| Eliminar arbol | No | Si (en sus centros) | Si |
| Crear centro | No | No | Si |
| Editar centro | No | Si (en sus centros) | Si |
| Eliminar centro | No | No | Si |
| Gestionar usuarios | No | No | Si |
| Gestionar dispositivos | No | Si (en sus centros) | Si |
| Asignar coordinadores a centros | No | No | Si |

> **Nota**: Un COORDINADOR solo puede gestionar los centros donde esta asignado (tabla `usuario_centro`). La mera existencia de una fila en esa tabla indica que el usuario coordina ese centro.

---

## Modelo de Datos

### Tabla `usuario`

| Campo | Tipo | Restricciones | Cambio |
|-------|------|---------------|--------|
| `id` | BIGSERIAL | PRIMARY KEY | - |
| `nombre` | VARCHAR(100) | NOT NULL | - |
| `email` | VARCHAR(150) | NOT NULL, UNIQUE | - |
| `password_hash` | VARCHAR(255) | NOT NULL | - |
| `rol` | VARCHAR(20) | NOT NULL, CHECK | CHECK cambia a `('ADMIN', 'COORDINADOR')` |
| `fecha_creacion` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | - |
| `activo` | BOOLEAN | NOT NULL, DEFAULT TRUE | - |

```sql
-- Antes
CONSTRAINT chk_usuario_rol CHECK (rol IN ('ADMIN', 'USUARIO'))

-- Despues
CONSTRAINT chk_usuario_rol CHECK (rol IN ('ADMIN', 'COORDINADOR'))
```

### Tabla `usuario_centro`

| Campo | Tipo | Restricciones | Cambio |
|-------|------|---------------|--------|
| `id` | BIGSERIAL | PRIMARY KEY | - |
| `usuario_id` | BIGINT | NOT NULL, FK | - |
| `centro_id` | BIGINT | NOT NULL, FK | - |
| ~~`rol_en_centro`~~ | ~~VARCHAR(30)~~ | ~~NOT NULL, CHECK~~ | **ELIMINAR** |
| `fecha_asignacion` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | - |
| `activo` | BOOLEAN | NOT NULL, DEFAULT TRUE | - |

```sql
-- Antes
CREATE TABLE usuario_centro (
    id BIGSERIAL,
    usuario_id BIGINT NOT NULL,
    centro_id BIGINT NOT NULL,
    rol_en_centro VARCHAR(30) NOT NULL,
    fecha_asignacion TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    activo BOOLEAN NOT NULL DEFAULT TRUE,
    ...
    CONSTRAINT chk_usuario_centro_rol CHECK (rol_en_centro IN ('COORDINADOR', 'PROFESOR', 'ESTUDIANTE', 'OBSERVADOR'))
);

-- Despues
CREATE TABLE usuario_centro (
    id BIGSERIAL,
    usuario_id BIGINT NOT NULL,
    centro_id BIGINT NOT NULL,
    fecha_asignacion TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    activo BOOLEAN NOT NULL DEFAULT TRUE,
    ...
    -- Sin CHECK de rol (la existencia de la fila = coordinacion)
);
```

### Backend (Java) — COMPLETADO

```java
// Rol.java
public enum Rol {
    ADMIN, COORDINADOR
}
```

Entidad `UsuarioCentro.java` creada sin campo `rolEnCentro` (la presencia en la tabla = coordinacion).
Repository y Controller con endpoints CRUD:
- `GET /api/usuario-centro/usuario/{usuarioId}` — centros de un usuario
- `GET /api/usuario-centro/centro/{centroId}` — coordinadores de un centro
- `POST /api/usuario-centro` — asignar coordinador (valida rol COORDINADOR, no duplicados)
- `DELETE /api/usuario-centro/{id}` — desasignar coordinador

Script de migracion: `backend/migrate_roles.sql` (idempotente con `IF EXISTS`).

---

## Usuarios de Prueba

Solo se necesitan 2 usuarios mock (el acceso publico no requiere cuenta):

| Email | Contrasena | Rol | Centros |
|-------|------------|-----|---------|
| admin@test.com | admin123 | ADMIN | Todos (implicito) |
| coordinador@test.com | coord123 | COORDINADOR | Centro 1 |

### admin@test.com
- **Rol**: ADMIN
- **Puede**: Todo (crear centros, gestionar usuarios, CRUD en cualquier centro)

### coordinador@test.com
- **Rol**: COORDINADOR
- **Centros**: Centro 1
- **Puede**: CRUD arboles y dispositivos en Centro 1, editar Centro 1

### Acceso publico (sin cuenta)
- **Puede**: Ver dashboard, ver todos los centros y arboles, ver detalles
- **No puede**: Crear, editar ni eliminar nada

---

## Fases de Implementacion

### Fase 1: Constantes y utilidades (COMPLETADA)

#### 1.1 Simplificar `src/constants/roles.js`
```javascript
// Antes
export const ROLES = { ADMIN: 'ADMIN', USUARIO: 'USUARIO' };
export const ROLES_CENTRO = {
  COORDINADOR: 'COORDINADOR',
  PROFESOR: 'PROFESOR',
  ESTUDIANTE: 'ESTUDIANTE',
  OBSERVADOR: 'OBSERVADOR'
};

// Despues
export const ROLES = { ADMIN: 'ADMIN', COORDINADOR: 'COORDINADOR' };
// Eliminar ROLES_CENTRO completamente
```

#### 1.2 Simplificar `src/utils/permissions.js`
- `isAdmin(user)` - Es administrador
- `isCoordinador(user)` - Es coordinador
- `canManageCenter(user, centroId)` - Es admin O coordinador asignado a ese centro
- `canEditArbol(user, centroId)` - Igual que canManageCenter
- `canDeleteArbol(user, centroId)` - Igual que canManageCenter
- Eliminar: `hasRoleInCenter`, `canAssignUsersToCenter`, y cualquier referencia a PROFESOR/ESTUDIANTE/OBSERVADOR

#### 1.3 Simplificar `src/hooks/usePermissions.js`
- Adaptar para usar las funciones simplificadas de permissions.js

---

### Fase 2: Contexto de autenticacion (COMPLETADA)

#### 2.1 Simplificar `src/context/AuthContext.jsx`
```javascript
// Antes: usuario con centros y rolEnCentro
const user = {
  id: 1, nombre: 'Juan', email: 'juan@test.com',
  rol: 'USUARIO',
  centros: [
    { centroId: 1, rolEnCentro: 'COORDINADOR' },
    { centroId: 2, rolEnCentro: 'PROFESOR' }
  ]
};

// Despues: usuario con centros (sin rolEnCentro)
const user = {
  id: 2, nombre: 'Maria', email: 'coordinador@test.com',
  rol: 'COORDINADOR',
  centros: [{ centroId: 1 }]  // Sin rolEnCentro, la presencia = coordinacion
};
```

#### 2.2 Reducir usuarios mock
- Solo 2: admin@test.com y coordinador@test.com
- Eliminar: profesor, estudiante, observador, nuevo

#### 2.3 Permitir navegacion sin login
- El estado `user: null` ya no redirige al login
- Un usuario no autenticado puede ver todo en modo solo lectura

---

### Fase 3: Rutas y proteccion (COMPLETADA)

#### 3.1 Adaptar `src/routes/ProtectedRoute.jsx`
- Rutas publicas por defecto (lectura): dashboard, listados, detalles
- Solo proteger rutas de escritura: `/arboles/nuevo`, `/arboles/:id/editar`, `/centros/nuevo`, etc.
- Redirigir a login cuando un usuario no autenticado intenta acceder a ruta protegida

#### 3.2 Simplificar `src/components/auth/RoleGate.jsx`
- Solo necesita comprobar ADMIN o COORDINADOR (ya no hay 4 roles de centro)

---

### Fase 4: Paginas de arboles (PENDIENTE)

#### 4.1 ListadoArboles.jsx
- Visible para todos (publico incluido)
- Boton "Nuevo Arbol" solo visible si el usuario tiene permisos de escritura
- Eliminar filtrado por roles de centro

#### 4.2 DetalleArbol.jsx
- Visible para todos
- Botones "Editar"/"Eliminar" solo si el usuario puede gestionar ese centro

#### 4.3 FormularioArbol.jsx
- Solo accesible para ADMIN o COORDINADOR del centro
- En creacion: solo mostrar centros donde puede crear (admin = todos, coordinador = sus centros)

---

### Fase 5: Paginas de centros (PENDIENTE)

#### 5.1 ListadoCentros.jsx
- Visible para todos
- Boton "Nuevo Centro" solo para ADMIN

#### 5.2 DetalleCentro.jsx
- Visible para todos
- Botones de edicion solo para ADMIN o COORDINADOR del centro

#### 5.3 FormularioCentro.jsx
- Crear: solo ADMIN
- Editar: ADMIN o COORDINADOR del centro

---

### Fase 6: Gestion de usuarios (PENDIENTE)

- Solo ADMIN puede ver/gestionar usuarios globalmente
- Pagina para asignar coordinadores a centros
- No hay roles de centro que asignar, solo la asignacion misma

---

## Archivos a Modificar

### Backend (COMPLETADO)

| Archivo | Cambio | Estado |
|---------|--------|--------|
| `Rol.java` (enum) | ADMIN, COORDINADOR (eliminar USUARIO) | Hecho |
| `UsuarioCentro.java` (entidad) | Nueva entidad sin `rolEnCentro` | Hecho |
| `UsuarioCentroRepository.java` | Nuevo repository con queries | Hecho |
| `UsuarioCentroController.java` | Nuevo controller con CRUD | Hecho |
| `create_database.sql` | Actualizar CHECKs y eliminar `rol_en_centro` | Hecho |
| `migrate_roles.sql` | Script de migracion idempotente | Hecho |

### Frontend

| Archivo | Cambio |
|---------|--------|
| `src/constants/roles.js` | Solo ADMIN y COORDINADOR, eliminar ROLES_CENTRO |
| `src/utils/permissions.js` | Simplificar funciones, eliminar roles de centro |
| `src/hooks/usePermissions.js` | Adaptar al nuevo modelo |
| `src/context/AuthContext.jsx` | 2 mock users, permitir navegacion sin login |
| `src/routes/ProtectedRoute.jsx` | Rutas publicas por defecto, proteger solo escritura |
| `src/components/auth/RoleGate.jsx` | Simplificar (solo ADMIN/COORDINADOR) |
| `src/layout/Header.jsx` | Adaptar navegacion para usuarios no autenticados |
| `src/pages/arboles/*.jsx` | Permisos simplificados |
| `src/pages/centros/*.jsx` | Permisos simplificados |
| `App.jsx` | Rutas publicas/protegidas |

### SQL (COMPLETADO)

Ver `backend/migrate_roles.sql` — script idempotente que:
1. Elimina constraints antiguos (`chk_usuario_rol`, `usuario_rol_check`) con `IF EXISTS`
2. Migra usuarios `USUARIO` → `COORDINADOR`
3. Añade nuevo CHECK `('ADMIN', 'COORDINADOR')`
4. Elimina columna `rol_en_centro` de `usuario_centro` con `IF EXISTS`

---

## Notas para Futuro (JWT)

Cuando se implemente JWT:
1. El token contendra `{ id, email, rol, centros: [centroId1, centroId2] }`
2. Solo cambia como se obtiene el usuario (decodificar token)
3. Toda la logica de permisos permanece igual
4. El backend validara permisos tambien (doble verificacion)
5. Los usuarios no autenticados simplemente no tendran token

---

## Informacion del Proyecto

**Nombre**: Garden Monitor - Sistema de Monitorizacion de Arboles

**Institucion**: IES El Rincon

**Curso**: Desarrollo de Aplicaciones Multiplataforma (DAM) 2025-2026

**Repositorio**: [github.com/riordi80/vocational-training-final-project](https://github.com/riordi80/vocational-training-final-project)

**Ultima actualizacion**: 2026-02-13

### Colaboradores

[![riordi80](https://img.shields.io/badge/riordi80-100000?style=for-the-badge&logo=github&logoColor=white)](https://github.com/riordi80) [![Enrique36247](https://img.shields.io/badge/Enrique36247-100000?style=for-the-badge&logo=github&logoColor=white)](https://github.com/Enrique36247)

---

**Proyecto Final DAM 2025-2026** | Desarrollado con Spring Boot, React, Android y ESP32
