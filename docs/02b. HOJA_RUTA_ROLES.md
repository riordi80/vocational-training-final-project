# Hoja de Ruta: Sistema de Roles Completo

**Fecha**: 2026-01-22
**Estado**: Pendiente
**Objetivo**: Implementar sistema de permisos con roles globales y roles por centro

---

## Resumen del Sistema

### Nivel 1: Roles Globales (Usuario)
| Rol | Descripción | Permisos globales |
|-----|-------------|-------------------|
| `ADMIN` | Administrador del sistema | Todo |
| `USUARIO` | Usuario estándar | Permisos según roles en centros asignados |

> **Nota**: Un USUARIO sin centros asignados solo puede ver el dashboard general. Sus permisos reales vienen de los roles que tenga en cada centro.

### Nivel 2: Roles en Centro (usuario_centro)
| Rol | Descripción | Permisos en el centro |
|-----|-------------|----------------------|
| `COORDINADOR` | Coordinador del centro | Gestiona centro, asigna roles |
| `PROFESOR` | Profesor del centro | Crea/edita árboles |
| `ESTUDIANTE` | Estudiante del centro | Solo lectura |
| `OBSERVADOR` | Observador | Solo lectura |

### Matriz de Permisos Detallada

#### Acciones Globales
| Acción | ADMIN | USUARIO |
|--------|-------|---------|
| Ver dashboard | ✅ | ✅ |
| Ver lista de centros | ✅ | ✅ (solo asignados) |
| Crear centro | ✅ | ❌ |
| Editar cualquier centro | ✅ | ❌ |
| Eliminar centro | ✅ | ❌ |
| Ver todos los árboles | ✅ | ❌ (solo de sus centros) |
| Gestionar usuarios | ✅ | ❌ |
| Asignar COORDINADOR | ✅ | ❌ |

> **Nota**: Un USUARIO puede hacer más cosas dentro de los centros donde tiene rol asignado (ver tabla siguiente).

#### Acciones en Centro (según rol en ese centro)
| Acción | COORDINADOR | PROFESOR | ESTUDIANTE | OBSERVADOR |
|--------|-------------|----------|------------|------------|
| Ver árboles del centro | ✅ | ✅ | ✅ | ✅ |
| Crear árbol | ✅ | ✅ | ❌ | ❌ |
| Editar árbol | ✅ | ✅ | ❌ | ❌ |
| Eliminar árbol | ✅ | ❌ | ❌ | ❌ |
| Editar centro | ✅ | ❌ | ❌ | ❌ |
| Asignar usuarios al centro | ✅ | ❌ | ❌ | ❌ |

---

## Fases de Implementación

### Fase 1: Estructura de Datos y Utilidades
**Objetivo**: Crear la base del sistema de permisos

#### 1.1 Crear constantes de roles
- [x] Crear `src/constants/roles.js`
  ```javascript
  // Roles globales (solo 2)
  export const ROLES = {
    ADMIN: 'ADMIN',
    USUARIO: 'USUARIO'
  };
  
  // Roles en centro (4 niveles de permiso)
  export const ROLES_CENTRO = {
    COORDINADOR: 'COORDINADOR',
    PROFESOR: 'PROFESOR',
    ESTUDIANTE: 'ESTUDIANTE',
    OBSERVADOR: 'OBSERVADOR'
  };
  ```

#### 1.2 Crear utilidades de permisos
- [x] Crear `src/utils/permissions.js`
  - [x] `hasRoleInCenter(user, centroId, roles)` - Verifica rol en centro específico
  - [x] `canCreateArbol(user, centroId)` - Puede crear árbol en centro
  - [x] `canEditArbol(user, centroId)` - Puede editar árbol en centro
  - [x] `canDeleteArbol(user, centroId)` - Puede eliminar árbol en centro
  - [x] `canManageCenter(user, centroId)` - Puede gestionar centro
  - [x] `canAssignUsersToCenter(user, centroId)` - Puede asignar usuarios
  - [x] `isAdminUser(user)` - Es administrador global

#### 1.3 Crear hook personalizado
- [x] Crear `src/hooks/usePermissions.js`
  - [x] Hook que combina `useAuth()` con las utilidades de permisos
  - [x] Retorna funciones de verificación listas para usar

---

### Fase 2: Actualizar Contexto de Autenticación
**Objetivo**: Adaptar AuthContext para el modelo completo

#### 2.1 Actualizar estructura del usuario
- [x] Modificar `src/context/AuthContext.jsx`
  - [x] Usuario ahora incluye `centros` (array de asignaciones)
  ```javascript
  const user = {
    id: 1,
    nombre: 'Juan',
    email: 'juan@test.com',
    rol: 'USUARIO',            // Rol global (ADMIN o USUARIO)
    centros: [                  // Roles por centro
      { centroId: 1, rolEnCentro: 'COORDINADOR' },
      { centroId: 2, rolEnCentro: 'PROFESOR' }
    ]
  };
  ```

#### 2.2 Crear usuarios de prueba
- [x] Definir usuarios mock para cada combinación de roles
  | Email | Contraseña | Rol Global | Centros |
  |-------|------------|------------|---------|
  | admin@test.com | admin123 | ADMIN | Todos (implícito) |
  | coordinador@test.com | coord123 | USUARIO | Centro 1: COORDINADOR |
  | profesor@test.com | prof123 | USUARIO | Centro 1: PROFESOR, Centro 2: PROFESOR |
  | estudiante@test.com | est123 | USUARIO | Centro 1: ESTUDIANTE |
  | observador@test.com | obs123 | USUARIO | Centro 1: OBSERVADOR |
  | nuevo@test.com | nuevo123 | USUARIO | Ninguno (sin asignar) |

#### 2.3 Actualizar login mock
- [x] Login reconoce usuarios de prueba
- [x] Carga roles en centros del usuario

#### 2.4 Actualizar registro
- [x] Registro crea usuarios con rol USUARIO
- [x] Sin asignación a centros (debe ser asignado por ADMIN/COORDINADOR)

---

### Fase 3: Actualizar Sistema de Rutas
**Objetivo**: Proteger rutas según permisos

#### 3.1 Mejorar ProtectedRoute
- [x] Modificar `src/routes/ProtectedRoute.jsx`
  - [x] Añadir prop `requiredRoles` (array de roles permitidos)
  - [x] Añadir prop `requireCenterRole` (para rutas de centro específico)

#### 3.2 Crear componente RoleGate
- [x] Crear `src/components/auth/RoleGate.jsx`
  - [x] Componente que muestra/oculta children según permisos
  - [x] Props: `roles`, `centroId`, `fallback`

#### 3.3 Crear página de acceso denegado
- [x] Crear `src/pages/AccessDenied.jsx`
  - [x] Mensaje claro de que no tiene permisos
  - [x] Botón para volver al dashboard

#### 3.4 Actualizar rutas en App.jsx
- [x] Añadir restricciones de rol a rutas sensibles
- [x] Rutas de creación/edición requieren permisos

---

### Fase 4: Actualizar Páginas de Árboles
**Objetivo**: Aplicar permisos en la gestión de árboles

#### 4.1 ListadoArboles.jsx
- [ ] Ocultar botón "Nuevo Árbol" si no tiene permiso
- [ ] Mostrar solo árboles de centros donde tiene acceso (o todos si ADMIN)

#### 4.2 DetalleArbol.jsx
- [ ] Ocultar botón "Editar" si no tiene permiso en ese centro
- [ ] Ocultar botón "Eliminar" si no tiene permiso (solo ADMIN o COORDINADOR)
- [ ] Mostrar mensaje si no tiene acceso al árbol

#### 4.3 FormularioArbol.jsx
- [ ] Verificar permiso antes de mostrar formulario
- [ ] En creación: solo mostrar centros donde puede crear
- [ ] En edición: verificar permiso en el centro del árbol
- [ ] Redirigir a AccessDenied si no tiene permiso

---

### Fase 5: Actualizar Páginas de Centros
**Objetivo**: Aplicar permisos en la gestión de centros

#### 5.1 ListadoCentros.jsx
- [ ] Ocultar botón "Nuevo Centro" si no es ADMIN
- [ ] Mostrar indicador de rol del usuario en cada centro

#### 5.2 DetalleCentro.jsx
- [ ] Ocultar botón "Editar" si no es ADMIN ni COORDINADOR del centro
- [ ] Ocultar botón "Eliminar" si no es ADMIN
- [ ] Mostrar sección de usuarios del centro (si es ADMIN o COORDINADOR)

#### 5.3 FormularioCentro.jsx
- [ ] Solo accesible para ADMIN (crear)
- [ ] Edición: ADMIN o COORDINADOR del centro

---

### Fase 6: Páginas de Gestión de Usuarios (Completa)
**Objetivo**: Crear páginas dedicadas para gestión de usuarios y asignaciones

#### 6.1 Crear ListadoUsuarios (solo ADMIN)
- [ ] Crear `src/pages/admin/ListadoUsuarios.jsx`
  - [ ] Tabla con todos los usuarios del sistema
  - [ ] Columnas: nombre, email, rol global, fecha creación, activo
  - [ ] Filtro por rol global
  - [ ] Buscador por nombre/email
  - [ ] Click en fila navega a DetalleUsuario
  - [ ] Badge de color según rol

#### 6.2 Crear DetalleUsuario (solo ADMIN)
- [ ] Crear `src/pages/admin/DetalleUsuario.jsx`
  - [ ] Información del usuario (nombre, email, fecha registro)
  - [ ] Selector para cambiar rol global
  - [ ] Toggle para activar/desactivar usuario
  - [ ] Lista de centros donde está asignado
  - [ ] Botón para asignar a nuevo centro
  - [ ] Botón volver a lista

#### 6.3 Crear GestionUsuariosCentro (ADMIN + COORDINADOR del centro)
- [ ] Crear `src/pages/centros/GestionUsuariosCentro.jsx`
  - [ ] Ruta: `/centros/:id/usuarios`
  - [ ] Mostrar nombre del centro
  - [ ] Tabla de usuarios asignados al centro
  - [ ] Columnas: nombre, email, rol en centro, fecha asignación
  - [ ] Botón para cambiar rol en centro (dropdown)
  - [ ] Botón para quitar usuario del centro
  - [ ] Botón para crear nuevo usuario en el centro
  - [ ] Modal de creación: nombre, email, contraseña, rol en centro
  - [ ] Al crear: se crea usuario (rol global USUARIO) + asignación al centro automáticamente

> **Nota**: El COORDINADOR solo ve usuarios de sus centros, NO tiene acceso a la lista global de usuarios. Solo ADMIN puede ver todos los usuarios del sistema.

#### 6.4 Crear servicios de usuarios
- [ ] Crear `src/services/usuariosService.js`
  - [ ] `getUsuarios()` - Lista todos los usuarios (solo ADMIN)
  - [ ] `getUsuarioById(id)` - Obtiene usuario por ID (solo ADMIN)
  - [ ] `updateUsuarioRol(id, rol)` - Cambia rol global (solo ADMIN)
  - [ ] `getUsuariosByCentro(centroId)` - Usuarios de un centro (ADMIN + COORDINADOR)
  - [ ] `crearUsuarioEnCentro(centroId, datos, rol)` - Crea usuario + asigna al centro
  - [ ] `actualizarRolEnCentro(usuarioId, centroId, rol)` - Cambiar rol en centro
  - [ ] `quitarUsuarioCentro(usuarioId, centroId)` - Quitar usuario del centro

#### 6.5 Actualizar navegación
- [ ] Añadir enlace "Usuarios" en Header (solo visible para ADMIN)
- [ ] Añadir botón "Gestionar usuarios" en DetalleCentro (ADMIN + COORDINADOR)

#### 6.6 Actualizar rutas en App.jsx
- [ ] `/admin/usuarios` → ListadoUsuarios (solo ADMIN)
- [ ] `/admin/usuarios/:id` → DetalleUsuario (solo ADMIN)
- [ ] `/centros/:id/usuarios` → GestionUsuariosCentro (ADMIN + COORDINADOR)

---

### Fase 7: Componentes de UI
**Objetivo**: Feedback visual del sistema de roles

#### 7.1 Mostrar rol en Header
- [ ] Actualizar `src/layout/Header.jsx`
  - [ ] Mostrar rol global del usuario
  - [ ] Badge visual según rol (colores diferentes)

#### 7.2 Indicadores de permiso
- [ ] Crear componente de badge de rol
- [ ] Tooltips explicativos cuando algo está deshabilitado

---

## Archivos a Crear/Modificar

### Nuevos archivos
```
src/
├── constants/
│   └── roles.js                        # Constantes de roles
├── utils/
│   └── permissions.js                  # Funciones de permisos
├── hooks/
│   └── usePermissions.js               # Hook de permisos
├── services/
│   └── usuariosService.js              # Servicio mock de usuarios
├── components/
│   └── auth/
│       └── RoleGate.jsx                # Componente condicional por rol
├── pages/
│   ├── AccessDenied.jsx                # Página de acceso denegado
│   └── admin/
│       ├── ListadoUsuarios.jsx         # Lista de usuarios (ADMIN)
│       └── DetalleUsuario.jsx          # Detalle de usuario (ADMIN)
│   └── centros/
│       └── GestionUsuariosCentro.jsx   # Usuarios de un centro (ADMIN + COORDINADOR)
```

### Total páginas nuevas: 4
1. `AccessDenied.jsx`
2. `ListadoUsuarios.jsx`
3. `DetalleUsuario.jsx`
4. `GestionUsuariosCentro.jsx`

### Archivos a modificar
```
src/
├── context/
│   └── AuthContext.jsx             # Estructura de usuario, usuarios mock
├── routes/
│   └── ProtectedRoute.jsx          # Verificación de roles
├── layout/
│   └── Header.jsx                  # Mostrar rol
├── pages/
│   ├── arboles/
│   │   ├── ListadoArboles.jsx      # Permisos en botones
│   │   ├── DetalleArbol.jsx        # Permisos en acciones
│   │   └── FormularioArbol.jsx     # Verificar acceso
│   └── centros/
│       ├── ListadoCentros.jsx      # Permisos en botones
│       ├── DetalleCentro.jsx       # Permisos + gestión usuarios
│       └── FormularioCentro.jsx    # Verificar acceso
├── App.jsx                         # Rutas con restricciones
```

---

## Usuarios de Prueba (Detalle)

### admin@test.com (Contraseña: admin123)
- **Rol global**: ADMIN
- **Centros**: Acceso implícito a todos
- **Puede**: Todo (crear centros, asignar COORDINADOR, gestionar usuarios)

### coordinador@test.com (Contraseña: coord123)
- **Rol global**: USUARIO
- **Centros**:
  - Centro 1: COORDINADOR
- **Puede**: Gestionar Centro 1, asignar usuarios a Centro 1 (excepto COORDINADOR)

### profesor@test.com (Contraseña: prof123)
- **Rol global**: USUARIO
- **Centros**:
  - Centro 1: PROFESOR
  - Centro 2: PROFESOR
- **Puede**: Crear/editar árboles en Centro 1 y 2

### estudiante@test.com (Contraseña: est123)
- **Rol global**: USUARIO
- **Centros**:
  - Centro 1: ESTUDIANTE
- **Puede**: Ver árboles de Centro 1

### observador@test.com (Contraseña: obs123)
- **Rol global**: USUARIO
- **Centros**:
  - Centro 1: OBSERVADOR
- **Puede**: Ver árboles de Centro 1 (solo lectura)

### nuevo@test.com (Contraseña: nuevo123)
- **Rol global**: USUARIO
- **Centros**: Ninguno (sin asignar)
- **Puede**: Ver dashboard general, solicitar acceso a centros

---

## Orden de Implementación Recomendado

1. **Fase 1**: Estructura base (roles.js, permissions.js, usePermissions.js)
2. **Fase 2**: AuthContext actualizado con usuarios mock
3. **Fase 3**: ProtectedRoute + RoleGate + AccessDenied
4. **Fase 4**: Páginas de árboles con permisos
5. **Fase 5**: Páginas de centros con permisos
6. **Fase 6**: Panel admin básico (opcional para entrega)
7. **Fase 7**: UI/UX mejoras

---

## Estimación

| Fase | Complejidad | Archivos |
|------|-------------|----------|
| Fase 1 | Baja | 3 nuevos |
| Fase 2 | Media | 1 modificado |
| Fase 3 | Media | 3 nuevos, 2 modificados |
| Fase 4 | Media | 3 modificados |
| Fase 5 | Media | 3 modificados |
| Fase 6 | Alta | 4 nuevos (páginas) + 1 servicio + 2 modificados |
| Fase 7 | Baja | 2 modificados |

### Resumen de páginas frontend

| Categoría | Páginas | Total |
|-----------|---------|-------|
| Autenticación | Login, Register | 2 |
| General | Dashboard, AccessDenied | 2 |
| Árboles | Listado, Detalle, Formulario | 3 |
| Centros | Listado, Detalle, Formulario, GestionUsuarios | 4 |
| Admin | ListadoUsuarios, DetalleUsuario | 2 |
| **TOTAL** | | **13 páginas** |

---

## Notas para Futuro (JWT)

Cuando se implemente JWT:
1. El token contendrá `{ id, email, rol, centros: [...] }`
2. Solo cambia cómo se obtiene el usuario (decodificar token)
3. Toda la lógica de permisos permanece igual
4. El backend validará permisos también (doble verificación)

---

## Post-Implementación: Tests

Una vez implementado el sistema de roles, los tests cubrirán:
- `permissions.js` - Funciones de verificación de permisos
- `usePermissions.js` - Hook de permisos
- `AuthContext.jsx` - Login con diferentes roles
- `ProtectedRoute.jsx` - Redirección según permisos
- `RoleGate.jsx` - Renderizado condicional
- Páginas con lógica de permisos

Esto añade **funcionalidad crítica** a los tests = mejor nota.

---

## Mejoras Futuras (Post-Entrega)

### Sistema de Solicitudes de Asignación

**Situación actual**: El COORDINADOR puede crear usuarios nuevos en su centro, pero no puede añadir usuarios que ya existen en el sistema (por ejemplo, un profesor que ya está registrado en otro centro).

**Motivo**: Para proteger la privacidad, el COORDINADOR no tiene acceso a la lista global de usuarios del sistema, solo ve los usuarios de sus centros.

**Solución propuesta**: Añadir un botón "Solicitar añadir usuario existente" donde el COORDINADOR introduce el email del usuario y el rol deseado. El ADMIN recibe la solicitud y la aprueba o rechaza.

**Prioridad**: Media (implementar cuando el sistema esté en uso real y surja la necesidad)
